# Схема базы данных для системы заказов

## Диаграмма связей

```
┌─────────────────┐
│      User       │
├─────────────────┤
│ id (PK)         │◄──┐
│ name            │   │
│ email           │   │
│ role            │   │
│ phone           │   │
└─────────────────┘   │
                      │
                      │ userId (FK)
                      │
┌─────────────────────────────────┐
│           Orders                │
├─────────────────────────────────┤
│ id (PK)                         │◄────────────┐
│ client_id (FK) ─────────┐       │             │
│ userId (FK)             │       │             │
│ deliveryMethod_id (FK)──┼───┐   │             │
│ orderStatus_id (FK) ────┼───┼─┐ │             │
│                         │   │ │ │             │
│ totalAmount             │   │ │ │             │ order_id (FK)
│ discount                │   │ │ │             │
│ notes                   │   │ │ │             │
│ deliveryAddress         │   │ │ │   ┌─────────────────────────────┐
│ trackingNumber          │   │ │ │   │  OrderStatusHistory         │
│                         │   │ │ │   ├─────────────────────────────┤
│ createdAt               │   │ │ │   │ id (PK)                     │
│ updatedAt               │   │ │ │   │ order_id (FK) ──────────────┘
│ issuedAt                │   │ │ │   │ orderStatus_id (FK) ────┐
│ paidAt                  │   │ │ │   │ userId (FK) ────────┐   │
└─────────────────────────────────┘   │ comment             │   │
      │                           │   │ │ createdAt           │   │
      │                           │   │ └─────────────────────────────┘
      │                           │   │                       │   │
      │ order_id (FK)             │   │                       │   │
      │                           │   │                       │   │
      ▼                           │   │   ┌───────────────────┘   │
┌─────────────────────────────┐   │   │   │                       │
│        OrderItems           │   │   │   ▼                       ▼
├─────────────────────────────┤   │   └─► User             OrderStatuses
│ id (PK)                     │   │                        ┌──────────────┐
│ order_id (FK) ──────────────┘   │                        │ id (PK)      │
│ autopart_id (FK, nullable) ────┼────┐                   │ name         │
│ warehouse_id (FK) ───────────┐  │    │                   │ hexColor     │
│ quantity                      │  │    │                   │ isLast       │
│ item_final_price              │  │    │                   └──────────────┘
│ article         ◄──────────┐  │  │    │
│ description     ◄──────────┼──┼──┘    │
└─────────────────────────────┘  │       │
                                 │       │
                                 │       ▼
                                 │   ┌─────────────────┐
                                 │   │   Autoparts     │
                                 │   ├─────────────────┤
                                 │   │ id (PK)         │
                                 │   │ article         │
                                 │   │ description     │
                                 │   │ brand_id (FK)   │
                                 │   │ category_id     │
                                 │   └─────────────────┘
                                 │
                                 └─► ┌─────────────────┐
                                     │   Warehouses    │
                                     ├─────────────────┤
                                     │ id (PK)         │
                                     │ name            │
                                     │ address         │
                                     └─────────────────┘

┌─────────────────┐
│    Clients      │
├─────────────────┤
│ id (PK)         │◄─── client_id (FK) ─── Orders
│ name            │
│ fullName        │
│ address         │
└─────────────────┘
      ▲
      │ client_id (FK)
      │
┌──────────────────────────────┐
│ ClientsDeliveryMethods       │
├──────────────────────────────┤
│ client_id (FK)               │
│ deliveryMethod_id (FK) ──┐   │
└──────────────────────────────┘
                           │
                           └─► ┌───────────────────┐
                               │ DeliveryMethods   │
                               ├───────────────────┤
                               │ id (PK)           │
                               │ name              │
                               │ hexColor          │
                               └───────────────────┘
```

## Описание моделей

### 1. Orders (Заказы)
**Основная модель для управления заказами**

| Поле | Тип | Описание |
|------|-----|----------|
| id | String (PK) | Уникальный идентификатор |
| client_id | String (FK) | Ссылка на клиента |
| userId | String? (FK) | Пользователь, создавший заказ |
| deliveryMethod_id | Int? (FK) | Способ доставки |
| orderStatus_id | Int (FK) | Текущий статус заказа |
| totalAmount | Float? | Общая сумма заказа |
| discount | Float | Скидка (по умолчанию 0) |
| notes | String? | Комментарии |
| deliveryAddress | String? | Адрес доставки |
| trackingNumber | String? | Номер отслеживания |
| createdAt | DateTime | Дата создания |
| updatedAt | DateTime | Дата обновления (автоматически) |
| issuedAt | DateTime? | Дата выдачи |
| paidAt | DateTime? | Дата оплаты |

**Связи:**
- ✅ Один клиент может иметь много заказов
- ✅ Один пользователь может создать много заказов
- ✅ Заказ имеет один способ доставки
- ✅ Заказ имеет один текущий статус
- ✅ Заказ имеет много позиций (OrderItems)
- ✅ Заказ имеет историю статусов (OrderStatusHistory)

---

### 2. OrderItems (Позиции заказа)
**Товары в заказе с защитой от потери данных**

| Поле | Тип | Описание |
|------|-----|----------|
| id | Int (PK) | Уникальный идентификатор |
| order_id | String (FK) | Ссылка на заказ |
| autopart_id | String? (FK) | Ссылка на запчасть (может быть NULL) |
| warehouse_id | Int (FK) | Склад, с которого отгружена запчасть |
| quantity | Int | Количество |
| item_final_price | Float | Финальная цена позиции |
| **article** | **String** | **Артикул (сохраняется навсегда)** ⭐ |
| **description** | **String** | **Описание (сохраняется навсегда)** ⭐ |

**Важно:** 
- 🔒 Поля `article` и `description` сохраняют данные о запчасти
- 🔒 Если запчасть удалена из каталога, `autopart_id` становится NULL
- 🔒 Но артикул и описание остаются в заказе навсегда
- 🔒 Это обеспечивает целостность исторических данных

**Связи:**
- ✅ Одна позиция принадлежит одному заказу
- ⚠️ Позиция может ссылаться на запчасть (или NULL, если удалена)
- ✅ Позиция связана со складом

---

### 3. OrderStatusHistory (История статусов)
**Полный аудит изменений статуса заказа**

| Поле | Тип | Описание |
|------|-----|----------|
| id | String (PK) | Уникальный идентификатор |
| order_id | String (FK) | Ссылка на заказ |
| orderStatus_id | Int (FK) | Статус |
| userId | String? (FK) | Пользователь, изменивший статус |
| comment | String? | Комментарий к изменению |
| createdAt | DateTime | Время изменения |

**Использование:**
```typescript
// Получить полную историю заказа
const history = await prisma.orderStatusHistory.findMany({
  where: { order_id: orderId },
  include: {
    orderStatus: true,
    user: { select: { name: true, email: true } }
  },
  orderBy: { createdAt: 'asc' }
});

// История покажет:
// 1. Заказ создан → admin@autohub.com → 7 дней назад
// 2. В обработке → ivan@example.com → 6 дней назад
// 3. Готов к выдаче → admin@autohub.com → 5 дней назад
// 4. Выдан → admin@autohub.com → 5 дней назад
// 5. Оплачен → admin@autohub.com → 4 дня назад (с комментарием)
```

---

### 4. OrderStatuses (Статусы заказов)
**Справочник статусов**

| Поле | Тип | Описание |
|------|-----|----------|
| id | Int (PK) | Уникальный идентификатор |
| name | String | Название статуса |
| hexColor | String | Цвет для UI |
| isLast | Boolean | Является ли статус финальным |

**Предустановленные статусы:**
1. 🆕 **Новый** (#3B82F6) - isLast: false
2. ⏳ **В обработке** (#F59E0B) - isLast: false
3. ✅ **Готов к выдаче** (#10B981) - isLast: false
4. 📦 **Выдан** (#8B5CF6) - isLast: false
5. 💰 **Оплачен** (#059669) - isLast: **true**
6. ❌ **Отменен** (#EF4444) - isLast: **true**

---

### 5. Clients (Клиенты)
**Покупатели и организации**

| Поле | Тип | Описание |
|------|-----|----------|
| id | String (PK) | Уникальный идентификатор |
| name | String | Краткое название |
| fullName | String | Полное название |
| address | String? | Адрес |

---

### 6. DeliveryMethods (Способы доставки)
**Варианты доставки заказов**

| Поле | Тип | Описание |
|------|-----|----------|
| id | Int (PK) | Уникальный идентификатор |
| name | String | Название способа |
| hexColor | String? | Цвет для UI |

**Предустановленные методы:**
- 🏪 Самовывоз (#3B82F6)
- 🚗 Курьер (#10B981)
- 📮 Новая Почта (#F59E0B)
- 📦 Укрпочта (#6366F1)

---

## Жизненный цикл заказа

```
┌─────────────────────────────────────────────────────────────────┐
│                    СОЗДАНИЕ ЗАКАЗА                               │
│                                                                  │
│ 1. Создается Orders с userId, client_id, initial status         │
│ 2. Создаются OrderItems с article и description из Autoparts    │
│ 3. Рассчитывается totalAmount                                   │
│ 4. Создается первая запись OrderStatusHistory                   │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                  ОБРАБОТКА ЗАКАЗА                                │
│                                                                  │
│ - Менеджер меняет статус на "В обработке"                       │
│ - Создается запись в OrderStatusHistory                         │
│ - Уведомление клиенту                                           │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                   ПОДГОТОВКА                                     │
│                                                                  │
│ - Товары собираются на складе                                   │
│ - Статус меняется на "Готов к выдаче"                          │
│ - Если доставка: добавляется trackingNumber                     │
│ - Устанавливается issuedAt                                      │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                    ВЫДАЧА                                        │
│                                                                  │
│ - Статус "Выдан"                                                │
│ - Клиент получил товар                                          │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│              ЗАВЕРШЕНИЕ (isLast: true)                           │
│                                                                  │
│ ВАРИАНТ А: "Оплачен"                                            │
│   - Устанавливается paidAt                                      │
│   - Заказ успешно завершен                                      │
│                                                                  │
│ ВАРИАНТ Б: "Отменен"                                            │
│   - Товары возвращаются на склад                                │
│   - Указывается причина в notes                                 │
└─────────────────────────────────────────────────────────────────┘
```

## Преимущества текущей архитектуры

### ✅ Защита данных
- OrderItems сохраняют article и description
- Удаление Autoparts не влияет на исторические заказы
- Полная история статусов с комментариями

### ✅ Аудит
- Каждое изменение статуса записывается
- Отслеживание действий пользователей
- Временные метки всех событий

### ✅ Гибкость
- Любое количество статусов
- Настраиваемые способы доставки
- Связь клиентов с доступными методами доставки

### ✅ Масштабируемость
- Разделение concerns (Orders, Items, History)
- Оптимизированные связи
- Готовность к индексации



